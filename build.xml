<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="xml-report-plugin-custom" basedir="." default="all">
  <import file="${basedir}/xml-report-plugin.xml"/>

  <property name="dist" value="dist"/>
  <property name="dist.tmp" value="out/dist.tmp"/>
  <property name="dist.unpacked" value="${dist.tmp}/unpacked"/>

  <target name="pack.agent" description="pack agent part of plugin">
    <property name="dist.output.agent" value="${dist.unpacked}/agent"/>
    <delete dir="${dist.output.agent}" quiet="true"/>
    <mkdir dir="${dist.output.agent}"/>

    <property name="dist.tmp.agent" value="${dist.tmp}/agent"/>
    <property name="dist.tmp.agent.content" value="${dist.tmp.agent}/xml-report-plugin/lib"/>
    <delete dir="${dist.tmp.agent}" quiet="true"/>
    <mkdir dir="${dist.tmp.agent.content}"/>

    <jar destfile="${dist.tmp.agent.content}/xml-report-plugin.jar"
         basedir="${agent.output.dir}" update="true"/>
    <jar destfile="${dist.tmp.agent.content}/xml-report-plugin-common.jar"
         basedir="${common.output.dir}" update="true"/>
    <zip destfile="${dist.output.agent}/xml-report-plugin.zip"
         basedir="${dist.tmp.agent}"
         update="true"/>
    <delete dir="${dist.tmp.agent}"/>
  </target>

  <target name="pack.server" description="pack server part of plugin">
    <property name="dist.output.server" value="${dist.unpacked}/server"/>
    <mkdir dir="${dist.output.server}"/>
    <jar destfile="${dist.output.server}/xml-report-plugin.jar"
         basedir="${server.output.dir}" update="true"/>
  </target>

  <target name="dist" depends="all">
    <delete dir="${dist}" quiet="true"/>
    <mkdir dir="${dist}"/>

    <delete dir="${dist.unpacked}" quiet="true"/>
    <mkdir dir="${dist.unpacked}"/>
    <antcall target="pack.agent"/>
    <antcall target="pack.server"/>

    <zip destfile="${dist}/xml-report-plugin.zip"
         basedir="${dist.unpacked}"
         update="true"/>
    <delete dir="${dist.tmp}"/>
  </target>

  <target name="deploy" depends="dist" description="deploy plugin to TeamCity">
    <copy todir="${user.home}/.BuildServer/plugins">
      <fileset dir="${dist}"/>
    </copy>
  </target>

  <target name="copy.log4j.configuration">
    <property name="tests.testdata" value="${basedir}/tests/testData"/>
    <copy todir="${tests.testoutput.dir}" file="${tests.testdata}/log4j.xml"/>
  </target>

  <target name="test">
    <delete dir="test-reports" quiet="true"/>
    <mkdir dir="test-reports"/>

    <antcall target="copy.log4j.configuration"/>

    <junit printsummary="on" fork="true" haltonfailure="false" haltonerror="false" failureproperty="failure_found"
           showoutput="true">
      <classpath refid="tests.runtime.module.classpath"/>

      <formatter type="xml"/>

      <batchtest todir="test-reports">
        <fileset dir="${tests.testoutput.dir}">
          <include name="**/*Test.class"/>
        </fileset>
      </batchtest>
    </junit>
    <antcall target="check_failures"/>
  </target>

  <target name="check_failures" if="failure_found">
    <fail message="Failures found"/>
  </target>

</project>