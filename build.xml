<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="test-report-parser-plugin-custom" basedir="." default="all">
    <import file="${basedir}/testreportparserplugin.xml"/>

    <property  name="dist" value="out\pack"/>
    <property  name="dist.output" value="${dist}\TestReportParserPlugin"/>

    <target name="pack.agent" depends="all" description="pack agent part of plugin plugin">
        <property  name="dist.output.agent" value="${dist.output}\agent" />
        <property  name="dist.tmp" value="${dist.output.agent}\zip" />
        <property  name="dist.tmp.agent.part" value="${dist.tmp}\TestReportParserPlugin\lib" />
        <mkdir dir="${dist.tmp.agent.part}"/>

        <jar destfile="${dist.tmp.agent.part}\TestReportParserPlugin.jar"
             basedir="${agent.output.dir}" update="true"/>
        <jar destfile="${dist.tmp.agent.part}\TestReportParserPluginCommon.jar"
             basedir="${common.output.dir}" update="true"/>
        <zip destfile="${dist.output.agent}\TestReportParserPlugin.zip"
             basedir="${dist.tmp}"
             update="true"/>
        <delete dir="${dist.tmp}"/>
    </target>

    <target name="pack.server" depends="all" description="pack server part of plugin">
        <property  name="dist.output.server" value="${dist.output}\server" />
        <mkdir dir="${dist.output.server}"/>
        <jar destfile="${dist.output.server}\TestReportParserPlugin.jar"
             basedir="${server.output.dir}" update="true"/>
    </target>

    <target name="dist" depends="pack.agent, pack.server"/>

    <target name="deploy" depends="dist" description="deploy plugin to TeamCity">
        <copy todir="${user.home}\.BuildServer\plugins">
            <fileset dir="${dist}"/>
        </copy>
    </target>

    <target name="test">
        <delete dir="test-reports" quiet="true"/>
        <mkdir dir="test-reports"/>

        <junit printsummary="on" fork="true" haltonfailure="false" haltonerror="false" failureproperty="failure_found"
               showoutput="true">
            <classpath refid="tests.runtime.module.classpath"/>

            <formatter type="xml"/>

            <batchtest todir="test-reports">
                <fileset dir="${tests.testoutput.dir}">
                    <include name="**/*Test.class"/>
                </fileset>
            </batchtest>
        </junit>
        <antcall target="check_failures"/>
    </target>

    <target name="check_failures" if="failure_found">
        <fail message="Failures found"/>
    </target>

</project>