<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="test-report-parser-plugin-custom" basedir="." default="all">
    <import file="${basedir}/testreportparserplugin.xml"/>

    <property name="dist" value="dist"/>
    <property name="dist.tmp" value="out/dist.tmp"/>
    <property name="dist.unpacked" value="${dist.tmp}/unpacked"/>

    <target name="pack.agent" description="pack agent part of plugin plugin">
        <property name="dist.unpacked.output.agent" value="${dist.unpacked}/agent"/>
        <delete dir="${dist.unpacked.output.agent}" quiet="true"/>
        <mkdir dir="${dist.unpacked.output.agent}"/>

        <property name="dist.tmp.agent" value="${dist.tmp}/agent"/>
        <property name="dist.tmp.agent.content" value="${dist.tmp.agent}/TestReportParserPlugin/lib"/>
        <delete dir="${dist.tmp.agent}" quiet="true"/>
        <mkdir dir="${dist.tmp.agent.content}"/>

        <jar destfile="${dist.tmp.agent.content}/TestReportParserPlugin.jar"
             basedir="${agent.output.dir}" update="true"/>
        <jar destfile="${dist.tmp.agent.content}/TestReportParserPluginCommon.jar"
             basedir="${common.output.dir}" update="true"/>
        <zip destfile="${dist.unpacked.output.agent}/TestReportParserPlugin.zip"
             basedir="${dist.tmp}"
             update="true"/>
        <delete dir="${dist.tmp.agent}"/>
    </target>

    <target name="pack.server" description="pack server part of plugin">
        <property name="dist.output.server" value="${dist.unpacked}/server"/>
        <mkdir dir="${dist.output.server}"/>
        <jar destfile="${dist.output.server}/TestReportParserPlugin.jar"
             basedir="${server.output.dir}" update="true"/>
    </target>

    <target name="dist" depends="all">
        <delete dir="${dist}" quiet="true"/>
        <mkdir dir="${dist}"/>

        <delete dir="${dist.unpacked}" quiet="true"/>
        <mkdir dir="${dist.unpacked}"/>
        <antcall target="pack.agent"/>
        <antcall target="pack.server"/>

        <zip destfile="${dist}/TestReportParserPlugin.zip"
             basedir="${dist.unpacked}"/>
        <delete dir="${dist.unpacked}"/>
    </target>

    <target name="deploy" depends="dist" description="deploy plugin to TeamCity">
        <copy todir="${user.home}/.BuildServer/plugins">
            <fileset dir="${dist}"/>
        </copy>
    </target>

    <target name="test">
        <delete dir="test-reports" quiet="true"/>
        <mkdir dir="test-reports"/>

        <junit printsummary="on" fork="true" haltonfailure="false" haltonerror="false" failureproperty="failure_found"
               showoutput="true">
            <classpath refid="tests.runtime.module.classpath"/>

            <formatter type="xml"/>

            <batchtest todir="test-reports">
                <fileset dir="${tests.testoutput.dir}">
                    <include name="**/*Test.class"/>
                </fileset>
            </batchtest>
        </junit>
        <antcall target="check_failures"/>
    </target>

    <target name="check_failures" if="failure_found">
        <fail message="Failures found"/>
    </target>

</project>